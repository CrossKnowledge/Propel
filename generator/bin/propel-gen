#!/bin/bash

# Determine the absolute path to the script and generator root
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
PROPEL_GEN_HOME="$( cd -P "$( dirname "$SOURCE" )/.." >/dev/null 2>&1 && pwd )"

BUILD_XML="$PROPEL_GEN_HOME/build-propel.xml"
PHING_BIN="$PROPEL_GEN_HOME/../vendor/bin/phing"

if [ ! -f "$BUILD_XML" ]; then
  echo "❌ Could not find build.xml at $BUILD_XML"
  exit 1
fi

if [ ! -x "$PHING_BIN" ]; then
  echo "❌ Phing binary not found or not executable at $PHING_BIN"
  exit 1
fi

PROJECT_DIR="$1"
TARGET="$2"
#shift 2
if [ -n "${PROJECT_DIR:-}" ] && [ -n "${TARGET:-}" ]; then
    shift 2
fi

"$PHING_BIN" -f "$BUILD_XML" -Dusing.propel-gen=true -Dproject.dir="$PROJECT_DIR" -Dtarget="$TARGET" "$@"
